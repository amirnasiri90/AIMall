# بررسی بخش سازمانی (Organizations) — مشکلات و بهبودها

## خلاصه
بخش سازمانی از نظر منطق کلی (ساخت سازمان، دعوت، نقش‌ها، محدودیت اعضا، قرارداد و سقف سکه) درست کار می‌کند، ولی چند مورد **ناقص** یا **قابل بهبود** وجود دارد.

---

## ۱. مشکلات حیاتی

### ۱.۱ عدم وجود «انتقال مالکیت»
- **مشکل:** در `leave()` به مالک گفته می‌شود: «مالک نمی‌تواند سازمان را ترک کند؛ ابتدا مالکیت را منتقل کنید.» ولی **هیچ API برای انتقال مالکیت** وجود ندارد.
- **نتیجه:** مالک عملاً نمی‌تواند سازمان را ترک کند.
- **راه‌حل:** اضافه کردن endpoint مثلاً `POST /organizations/:id/transfer-ownership` با `body: { newOwnerMemberId: string }` (فقط برای OWNER).

### ۱.۲ عدم امکان لغو دعوتنامه
- **مشکل:** وقتی یک دعوتنامهٔ PENDING ارسال می‌شود، هیچ endpoint برای **لغو/باطل کردن** آن توسط OWNER/ADMIN وجود ندارد.
- **راه‌حل:** اضافه کردن مثلاً `DELETE /organizations/:id/invitations/:invitationId` یا `POST .../invitations/:invitationId/cancel` برای OWNER/ADMIN.

### ۱.۳ اعتبارسنجی نقش در `updateMemberRole`
- **مشکل:** در `PATCH :id/members/:memberId` فقط `role` از body خوانده می‌شود؛ **چک نمی‌شود** که مقدار یکی از `ADMIN` یا `MEMBER` باشد. مقدار اشتباه (مثلاً `OWNER` یا رشتهٔ نامعتبر) می‌تواند ذخیره شود.
- **راه‌حل:** فقط مقادیر مجاز `ADMIN` و `MEMBER` را بپذیرید و برای بقیه `BadRequestException` برگردانید.

---

## ۲. بهبودهای مهم

### ۲.۱ به‌روزرسانی نام سازمان
- **وضعیت:** `PATCH /organizations/:id` فقط `memberLimit` را به‌روز می‌کند.
- **پیشنهاد:** امکان به‌روزرسانی `name` (و در صورت نیاز به‌روزرسانی `slug`) اضافه شود تا سازمان بدون حذف/ایجاد مجدد قابل ویرایش باشد.

### ۲.۲ Validation و DTO
- **create:** فقط `name` از body؛ بدون حداقل/حداکثر طول و بدون DTO با `class-validator`.
- **invite:** `email` (فرمت ایمیل) و `role` (enum: ADMIN | MEMBER) بدون validation.
- **پیشنهاد:** استفاده از DTOها و `ValidationPipe` برای جلوگیری از ورودی نامعتبر.

### ۲.۳ آمار مصرف اعضا (`getMemberUsageStats`)
- **وضعیت:** مدل `Transaction` فیلد `organizationId` ندارد؛ آمار بر اساس **کل تراکنش‌های کاربر** (هم شخصی هم در هر سازمان) محاسبه می‌شود.
- **نتیجه:** در صفحهٔ سازمان، «مصرف هر عضو» در واقع «مصرف کل آن کاربر» است، نه فقط مصرف در همان سازمان.
- **پیشنهاد:**  
  - **گزینه A:** اضافه کردن فیلد اختیاری `organizationId` به `Transaction` و پر کردن آن هنگام کسر سکه در context سازمان؛ سپس فیلتر کردن آمار بر اساس آن.  
  - **گزینه B:** اگر منطق کسب‌وکار «مصرف کل کاربر» است، در مستندات و UI واضح شود که این عدد «مصرف کلی عضو» است نه «فقط در این سازمان».

---

## ۳. موارد اختیاری

### ۳.۱ حذف سازمان
- endpoint برای **حذف (dissolve) سازمان** وجود ندارد. در ARD، «قرارداد سازمانی» در فاز ۳ آمده؛ ممکن است حذف سازمان عمداً در scope نباشد. در صورت نیاز می‌توان `DELETE /organizations/:id` (فقط برای OWNER با تأیید) اضافه کرد.

### ۳.۲ مستندات Swagger
- می‌توان برای endpointهای سازمان از DTOها، `@ApiBody` / `@ApiResponse` و `@ApiBearerAuth()` استفاده کرد تا مستندات OpenAPI کامل‌تر شود.

### ۳.۳ قرارداد و سقف سکه
- `OrgContractService.ensureContractActiveForUser` قبل از `UsersService.deductCoins` فراخوانی می‌شود؛ یعنی کسر سکه در صورت قرارداد منقضی انجام نمی‌شود. این بخش درست است.
- `getEffectiveCoinCap` و `getBillingContextForUser` برای سقف سکه و تاریخ پایان قرارداد استفاده می‌شوند؛ در صورت چند سازمان، فقط یک `organizationName` برگردانده می‌شود. در صورت نیاز به نمایش «به ازای هر سازمان» می‌توان خروجی را به آرایهٔ سازمان‌ها گسترش داد.

---

## ۴. جمع‌بندی اقدامات پیشنهادی

| اولویت | مورد | اقدام |
|--------|------|--------|
| بالا | انتقال مالکیت | اضافه کردن `POST :id/transfer-ownership` |
| بالا | لغو دعوتنامه | اضافه کردن `DELETE :id/invitations/:invitationId` (یا مشابه) |
| بالا | اعتبارسنجی نقش | در `updateMemberRole` فقط `ADMIN` یا `MEMBER` قبول شود |
| متوسط | نام سازمان | اضافه کردن به‌روزرسانی `name` در `PATCH :id` |
| متوسط | DTO/Validation | DTO برای create و invite با class-validator |
| متوسط | آمار مصرف | تصمیم‌گیری دربارهٔ فیلتر بر اساس سازمان و در صورت نیاز تغییر مدل/منطق |
| پایین | حذف سازمان / Swagger | در صورت نیاز به قابلیت یا مستندات |

اگر موافق باشید، می‌توان مرحلهٔ اول (انتقال مالکیت، لغو دعوتنامه، اعتبارسنجی نقش) را در بک‌اند اعمال کرد.
