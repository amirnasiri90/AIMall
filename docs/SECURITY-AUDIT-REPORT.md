# گزارش بررسی امنیتی پروژه AI Mall

تاریخ بررسی: بهمن ۱۴۰۴

**تغییرات اعمال‌شده پس از بررسی:** مرکز ثقل رازها (`common/config/secrets.ts`)، اجباری بودن `JWT_SECRET` در production، CORS محدود به `FRONTEND_URL` در production، Helmet، پذیرش توکن در query فقط برای مسیرهای SSE، حداقل ۸ کاراکتر برای رمز عبور، هشدار برای `API_KEY_ENCRYPTION_KEY` و `FRONTEND_URL` در production.

---

## خلاصه اجرایی

پروژه از نظر احراز هویت، کنترل دسترسی و اعتبارسنجی ورودی در وضعیت قابل قبولی است. چند نقطهٔ قابل بهبود (عمدتاً برای محیط production) و یک مورد متوسط (توکن در query string) شناسایی شد. هیچ باگ بحرانی (مثل SQL Injection یا شکست کامل احراز هویت) مشاهده نشد.

---

## ۱. احراز هویت و JWT

### موارد مثبت
- **رمز عبور:** با bcrypt و cost 10 هش می‌شود؛ در پاسخ‌ها فیلد `password` حذف می‌شود.
- **اعتبارسنجی JWT:** در `JwtStrategy` کاربر از دیتابیس با `validateUser(payload)` بارگذاری می‌شود؛ نقش (role) همیشه از دیتابیس است، نه فقط از توکن.
- **مدت اعتبار توکن:** ۷ روز (`expiresIn: '7d'`).

### یافته‌های امنیتی

| شدت | موضوع | توضیح |
|-----|--------|--------|
| **بالا** | **JWT Secret پیش‌فرض** | در `auth.module.ts`, `jwt.strategy.ts`, `api-keys.module.ts`, `agents.module.ts` در صورت نبودن `JWT_SECRET` در env از مقدار ثابت `aimall-demo-secret-key-2024` استفاده می‌شود. در **production** حتماً `JWT_SECRET` را با مقدار قوی و یکتا در env تنظیم کنید و این fallback را در محیط پروداکشن غیرفعال یا حذف کنید. |
| **متوسط** | **توکن در query string** | در `ApiKeyAuthGuard` توکن از `request.query?.token` هم خوانده می‌شود (برای EventSource/SSE). توکن در URL ممکن است در لاگ سرور، تاریخچه مرورگر یا Referer نشت کند. بهتر است فقط از `Authorization: Bearer` یا `X-Api-Key` استفاده شود؛ در صورت نگه داشتن query، فقط برای SSE و با هشدار به توسعه‌دهنده باشد. |

---

## ۲. کنترل دسترسی (Authorization)

### موارد مثبت
- **ادمین:** مسیرهای `/admin` با `JwtAuthGuard` و `RolesGuard` و `@Roles('ADMIN')` محافظت شده‌اند؛ فقط JWT (نه API Key) برای ادمین استفاده می‌شود.
- **مالکیت منبع:** در سرویس‌های مکالمات و چت (`conversations.service`, `chat.service`) قبل از استفاده از `conversationId` بررسی می‌شود که `conv.userId === userId` تا از دسترسی به مکالمه دیگران جلوگیری شود (جلوگیری از IDOR).
- **سازمان‌ها:** نقش‌ها (OWNER, ADMIN, MEMBER) و محدودیت‌ها در سرویس سازمان‌ها اعمال شده است.

### یافته
- **ادمین و API Key:** مسیرهای ادمین فقط با JWT کار می‌کنند؛ API Key به ادمین دسترسی ندارد — مناسب است.

---

## ۳. اعتبارسنجی ورودی و تزریق

### موارد مثبت
- **ValidationPipe سراسری:** با `whitelist: true` و `transform: true` فعال است.
- **DTOها:** برای ثبت‌نام، ورود، ایجاد پرداخت و غیره از class-validator استفاده شده است.
- **دیتابیس:** استفاده از Prisma با کوئری‌های پارامتریشده؛ در `admin.service` از `Prisma.sql` با placeholder استفاده شده و ریسک SQL Injection پایین است.

### یافته‌ها

| شدت | موضوع | توضیح |
|-----|--------|--------|
| **پایین** | **حداقل طول رمز عبور** | رمز عبور حداقل ۶ کاراکتر است. برای production پیشنهاد می‌شود حداقل ۸ کاراکتر و در صورت امکان سیاست پیچیدگی (حروف، اعداد، نماد) در نظر گرفته شود. |
| **اطلاعی** | **ابزار code-runner** | در `code-runner.executor.ts` کد کاربر در یک sandbox با `new Function` اجرا می‌شود. در جاوااسکریپت امکان فرار از sandbox از طریق prototype وجود دارد. این ابزار فقط برای ادمین است؛ در هر صورت بهتر است در صورت استفادهٔ واقعی، اجرا در محیط ایزوله (مثلاً worker جدا یا سرویس مخصوص) در نظر گرفته شود. |

- **XSS:** تنها استفاده از `innerHTML` در فرانت با رشته ثابت (پیام «تصویر در دسترس نیست») است و ورودی کاربر در آن استفاده نشده — ریسک پایین.

---

## ۴. CORS و هدرهای امنیتی

### یافته‌ها

| شدت | موضوع | توضیح |
|-----|--------|--------|
| **متوسط** | **CORS با `origin: true`** | در `main.ts` با `origin: true` هر origin پذیرفته می‌شود. برای **production** بهتر است فقط دامنهٔ فرانت مجاز باشد، مثلاً: `origin: process.env.FRONTEND_URL?.split(',') || false`. |
| **پایین** | **عدم استفاده از Helmet** | هدرهای امنیتی (مثل X-Frame-Options, X-Content-Type-Options, Content-Security-Policy) تنظیم نشده‌اند. پیشنهاد: نصب و استفاده از `helmet` در Nest. |

---

## ۵. محدودیت نرخ (Rate Limiting)

### موارد مثبت
- **ThrottlerGuard سراسری:** با حد ۱۰۰ درخواست در ۶۰ ثانیه (قابل تنظیم با `THROTTLE_LIMIT`) فعال است.
- **PolicyThrottleInterceptor:** برای سیاست‌های اضافه (مثلاً محدودیت بر اساس کاربر/سرویس) وجود دارد.

---

## ۶. رازها (Secrets) و محیط

### موارد مثبت
- **`.env` در `.gitignore`:** قرار دارد و در ریپو کامیت نمی‌شود.
- **API Keyهای سرویس:** در دیتابیس با رمزنگاری (در صورت تنظیم `API_KEY_ENCRYPTION_KEY`) یا به صورت hash (برای کلیدهای API کاربر با پیشوند `aimall_`) نگهداری می‌شوند.

### یافته‌ها

| شدت | موضوع | توضیح |
|-----|--------|--------|
| **متوسط** | **رمزنگاری کلید API سرویس** | در `api-key-cipher.ts` اگر `API_KEY_ENCRYPTION_KEY` خالی یا کوتاه باشد، `getKey()` برابر null است و encrypt/decrypt همان مقدار ورودی را برمی‌گردانند (ذخیره بدون رمز). در production حتماً `API_KEY_ENCRYPTION_KEY` را با مقدار قوی (حداقل ۱۶ کاراکتر) تنظیم کنید. |
| **پایین** | **لاگ OTP در حالت بدون SMS** | در `auth.service.ts` وقتی SMS پیکربندی نشده، کد OTP با `console.log` چاپ می‌شود. در production اگر به‌طور موقت SMS قطع شود، OTP در لاگ ظاهر می‌شود. بهتر است این لاگ فقط وقتی `NODE_ENV !== 'production'` باشد اجرا شود. |

---

## ۷. آپلود فایل و پرداخت

### آپلود فایل (صوت – STT)
- از `FileInterceptor` و Multer استفاده می‌شود؛ نوع و حداکثر حجم فایل در کنترلر محدود نشده است. پیشنهاد: محدودیت حجم (مثلاً ۲۵ مگ) و در صورت امکان بررسی نوع MIME مجاز برای کاهش ریسک DoS و فایل‌های نامعتبر.

### پرداخت (زرین‌پال)
- **تأیید پرداخت:** فقط با `authority` و `status` از query انجام می‌شود؛ مبلغ و سکه از رکورد سفارش در دیتابیس خوانده می‌شود — مناسب است.
- **Redirect بعد از پرداخت:** به `FRONTEND_URL` از env انجام می‌شود؛ در production مطمئن شوید این مقدار تحت کنترل شماست و به دامنهٔ معتبر اشاره دارد.

---

## ۸. وابستگی‌ها

- نسخه‌های Nest، Prisma، bcrypt و سایر پکیج‌ها در حد معمول به‌روز هستند. توصیه: اجرای منظم `npm audit` و رفع آسیب‌پذیری‌های شناخته‌شده.

---

## اقدامات پیشنهادی (اولویت‌بندی)

### فوری (قبل از production)
1. ✅ **انجام شد:** تنظیم **`JWT_SECRET`** — در production اجباری است (بدون fallback). تابع مرکزی `getJwtSecret()` در `common/config/secrets.ts`.
2. ✅ **هشدار اضافه شد:** **`API_KEY_ENCRYPTION_KEY`** — در production در صورت خالی بودن، هشدار در لاگ چاپ می‌شود.
3. ✅ **انجام شد:** محدود کردن **CORS** — در production فقط دامنه‌های `FRONTEND_URL` (جدا شده با کاما) مجازند.

### کوتاه‌مدت
4. ✅ **انجام شده بود:** جلوگیری از لاگ OTP در production.
5. ✅ **انجام شد:** **Helmet** برای هدرهای امنیتی اضافه شد.
6. ✅ **انجام شده بود:** محدودیت حجم آپلود صوتی (۲۵ مگ).

### اختیاری
7. ✅ **انجام شد:** توکن در **query string** فقط برای مسیرهای SSE (مثل `/stream`) پذیرفته می‌شود؛ بقیهٔ API فقط از هدر.
8. ✅ **انجام شد:** حداقل طول **رمز عبور** به ۸ کاراکتر افزایش یافت (ثبت‌نام، ورود، ادمین).

---

این گزارش بر اساس بررسی کد در تاریخ فوق تهیه شده است. برای ممیزی رسمی یا صدور گواهی امنیتی، استفاده از تیم امنیت یا ابزارهای خودکار (مثل SAST/DAST) توصیه می‌شود.
