import { Injectable, Logger } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { ProviderManagerService } from '../providers/provider-manager.service';
import { UsersService } from '../users/users.service';
import { MessagesService } from '../messages/messages.service';
import { PolicyService } from '../policy/policy.service';

export interface AgentDefinition {
  id: string;
  name: string;
  description: string;
  tags: string[];
  status: 'active' | 'coming_soon';
  icon: string;
  coinCost: number;
}

interface StudentTutorParams {
  level: 'simple' | 'standard' | 'advanced';
  style: string;
  mode: 'fast' | 'eco' | 'accurate';
  subject?: string;
  integrityMode: boolean;
  place?: string;
  timePerDay?: string;
  travelStyle?: string;
  destinationType?: string;
  workspaceContext?: string;
}

const GENERIC_LEVEL_MAP: Record<string, string> = {
  simple: 'ูุจุชุฏ โ ุฎู ุณุงุฏู ู ุฎูุงุตู',
  standard: 'ูุชูุณุท โ ุจุง ุฌุฒุฆุงุช ูุงุฒู',
  advanced: 'ูพุดุฑูุชู โ ููุตู ุจุง ุฌุฒุฆุงุช ู ฺฏุฒููโูุง ุจุดุชุฑ',
};
const GENERIC_STYLE_MAP: Record<string, string> = {
  brief: 'ฺฉูุชุงู ู ุฎูุงุตู',
  detailed: 'ููุตู ู ฺฉุงูู',
  with_alternatives: 'ุจุง ฺฏุฒููโูุง ุฌุงฺฏุฒู',
  hint_only: 'ฺฉูุชุงู',
  full_solution: 'ููุตู',
  formula_only: 'ุจุง ุฌุงฺฏุฒู',
};

const MODEL_MAP: Record<string, string> = {
  fast: 'openai/gpt-4o-mini',
  eco: 'openai/gpt-3.5-turbo',
  accurate: 'anthropic/claude-3-haiku',
};

const COIN_MAP: Record<string, number> = {
  fast: 2,
  eco: 1,
  accurate: 4,
};

const AGENTS: AgentDefinition[] = [
  {
    id: 'student-tutor',
    name: 'ุฏุณุชุงุฑ ุฏุงูุดโุขููุฒ',
    description: 'ูุนูู ููุดููุฏ ุจุฑุง ุฏุงูุดโุขููุฒุงู ู ุฏุงูุดุฌูุงู ุงุฑุงู โ ุชุฏุฑุณุ ุญู ุชูุฑู ู ุฑุงูููุง ฺฏุงูโุจูโฺฏุงู',
    tags: ['ุขููุฒุด', 'ุฑุงุถ', 'ุนููู', 'ุชูุฑู'],
    status: 'active',
    icon: 'GraduationCap',
    coinCost: 2,
  },
  {
    id: 'fitness-diet',
    name: 'ุฏุณุชุงุฑ ูุฑุฒุดุ ุชูุงุณุจ ุงูุฏุงู ู ุฑฺู',
    description: 'ุจุฑูุงูู ุชูุฑูุ ุชุบุฐู ู ูพฺฏุฑ ุจุฑุง ฺฉุงุฑุจุฑุงู ุงุฑุงู โ ุจุฏูู ุชุฌูุฒ ูพุฒุดฺฉุ ุจุง ุชูุฑฺฉุฒ ุฑู ุนุงุฏุช ูพุงุฏุงุฑ ู ุงูู',
    tags: ['ูุฑุฒุด', 'ุชูุงุณุจ ุงูุฏุงู', 'ุฑฺู', 'ุชุบุฐู', 'ุจุฑูุงูู ุชูุฑู'],
    status: 'active',
    icon: 'Dumbbell',
    coinCost: 2,
  },
  {
    id: 'travel-tourism',
    name: 'ุฏุณุชุงุฑ ฺฏุฑุฏุดฺฏุฑุ ุณูุฑ ู ูุงุฌุฑุงุฌู',
    description: 'ุจุฑูุงููโุฑุฒ ุณูุฑุ ูพุดููุงุฏ ููุตุฏุ ุทุฑุงุญ ุจุฑูุงูู ุฑูุฒุจูโุฑูุฒ ู ูฺฉุงุช ูุฑููฺฏ โ ุณูุฑ ุฏุงุฎู ู ุฎุงุฑุฌ ููุดููุฏ ู ุงูุชุตุงุฏ',
    tags: ['ุณูุฑ', 'ฺฏุฑุฏุดฺฏุฑ', 'ููุตุฏ', 'ุจุฑูุงูู ุณูุฑ', 'ุทุจุนุชโฺฏุฑุฏ', 'ุงุฑุงู'],
    status: 'active',
    icon: 'MapPin',
    coinCost: 2,
  },
  {
    id: 'academic-integrity',
    name: 'ูุดุงูุฑ ุตุฏุงูุช ุนูู',
    description: 'ุจุฑุฑุณ ู ุฑุงูููุง ุฏุฑุจุงุฑู ุงุตูู ูฺฏุงุฑุด ุนููุ ูุฑุงุฌุนโุฏู ู ุฌููฺฏุฑ ุงุฒ ุณุฑูุช ุงุฏุจ',
    tags: ['ุฏุงูุดฺฏุงู', 'ูฺฏุงุฑุด', 'ูพฺููุด'],
    status: 'coming_soon',
    icon: 'ShieldCheck',
    coinCost: 2,
  },
  {
    id: 'pdf-qa',
    name: 'ุฏุณุชุงุฑ PDF ู ุณูุฏ',
    description: 'ุขูพููุฏ ฺฉุชุงุจ ุง ุฌุฒูู PDF ู ูพุฑุณุด ู ูพุงุณุฎ ููุดููุฏ ุงุฒ ูุญุชูุง ุขู',
    tags: ['PDF', 'ูุทุงูุนู', 'ุฎูุงุตู'],
    status: 'coming_soon',
    icon: 'FileText',
    coinCost: 3,
  },
  {
    id: 'flashcards',
    name: 'ููุดโฺฉุงุฑุช ู ุฎูุงุตู ุงูุชุญุงู',
    description: 'ุณุงุฎุช ุฎูุฏฺฉุงุฑ ููุดโฺฉุงุฑุช ู ุฎูุงุตู ุงูุชุญุงู ุงุฒ ูุชู ุฏุฑุณ ุดูุง',
    tags: ['ููุดโฺฉุงุฑุช', 'ุงูุชุญุงู', 'ูุฑูุฑ'],
    status: 'coming_soon',
    icon: 'Layers',
    coinCost: 2,
  },
  {
    id: 'practice-gen',
    name: 'ุชููุฏ ุชูุฑู ุชุทุจู',
    description: 'ุชููุฏ ุณูุงูุงุช ุชูุฑู ูุชูุงุณุจ ุจุง ุณุทุญ ุดูุง ฺฉู ุชุฏุฑุฌุงู ุณุฎุชโุชุฑ ูโุดููุฏ',
    tags: ['ุชูุฑู', 'ุขุฒููู', 'ุชุทุจู'],
    status: 'coming_soon',
    icon: 'Target',
    coinCost: 2,
  },
  {
    id: 'english-tutor',
    name: 'ูุนูู ุฒุจุงู ุงูฺฏูุณ',
    description: 'ุขููุฒุด ุฒุจุงู ุงูฺฏูุณ ุดุงูู ฺฏุฑุงูุฑุ ูุบุชุ ูฺฉุงููู ู ุขูุงุฏฺฏ ุขูุชุณ/ุชุงูู',
    tags: ['ุงูฺฏูุณ', 'ฺฏุฑุงูุฑ', 'ุขูุชุณ'],
    status: 'coming_soon',
    icon: 'Languages',
    coinCost: 2,
  },
  {
    id: 'fashion',
    name: 'ูุดู ู ูุฏ',
    description: 'ุณุงุฎุช ุณุชุ ูุดุงูุฑู ุงุณุชุงูุ ุชุญูู ุนฺฉุณุ ุฎุฑุฏ ููุดููุฏ ู ฺฉูุฏ ุฏุฌุชุงู',
    tags: ['ูุดู', 'ุงุณุชุงู', 'ุณุชโุณุงุฒ', 'ฺฉูุฏ ุฏุฌุชุงู'],
    status: 'active',
    icon: 'Shirt',
    coinCost: 2,
  },
  {
    id: 'home',
    name: 'ุฎุงููโุฏุงุฑ ู ุขุดูพุฒ',
    description: 'ูพุดููุงุฏ ุบุฐุง ุจุง ููุงุฏ ููุฌูุฏุ ุฏุณุชูุฑ ูพุฎุช ูุฑุญููโุงุ ุจุฑูุงูู ุบุฐุง ู ูุณุช ุฎุฑุฏ',
    tags: ['ุขุดูพุฒ', 'ุฎุงููโุฏุงุฑ', 'ุฏุณุชูุฑ ูพุฎุช', 'ุจุฑูุงูู ุบุฐุง'],
    status: 'active',
    icon: 'Home',
    coinCost: 2,
  },
  {
    id: 'finance',
    name: 'ุณุฑูุงูโฺฏุฐุงุฑ ู ูุงู',
    description: 'ุชุญูู ุขููุฒุดุ ุณูุงุฑูุณุงุฒุ ูุงฺโูุณุช ู ฺูุฑูุงู ูุนุงููุงุช โ ุจุฏูู ูุนุฏู ุณูุฏ ูุทุน',
    tags: ['ุณุฑูุงูโฺฏุฐุงุฑ', 'ูุงู', 'ูุงฺโูุณุช', 'ุชุญูู'],
    status: 'active',
    icon: 'Wallet',
    coinCost: 2,
  },
  {
    id: 'lifestyle',
    name: 'ุณุจฺฉ ุฒูุฏฺฏ ู ุฑูุชู ุฑูุฒุงูู',
    description: 'ุจุฑูุงููโุฑุฒ ุฑูุฒุงููุ ุชุณฺฉโูุงุ ุฑูุชู ู ูพฺฏุฑ ุนุงุฏุช',
    tags: ['ุฑูุชู', 'ุชุณฺฉ', 'ุนุงุฏุช', 'ุจุฑูุงููโุฑุฒ'],
    status: 'active',
    icon: 'CalendarCheck',
    coinCost: 2,
  },
  {
    id: 'instagram-admin',
    name: 'ุงุฑ ุงุฏูู ุงูุณุชุงฺฏุฑุงู',
    description: 'ุชููู ูุญุชูุงุ ุณูุงุฑู ุฑูุฒุ ฺฉูพุดู ู ูุดุชฺฏุ ูพุงุณุฎ ุฏุงุฑฺฉุช ุจุง ูุญู ุจุฑูุฏ',
    tags: ['ุงูุณุชุงฺฏุฑุงู', 'ูุญุชูุง', 'ุฑูุฒ', 'ุจุฑูุฏ'],
    status: 'active',
    icon: 'Camera',
    coinCost: 2,
  },
  {
    id: 'persian-pdf-maker',
    name: 'ุชุจุฏู ุจู PDF (ูุงุฑุณ)',
    description: 'ูุชู ุง ูุงู Word ูุงุฑุณ ุฑุง ุจุง ฺฉูุช ุงุณุชุงูุฏุงุฑุฏ ุจู PDF ุชุจุฏู ฺฉู.',
    tags: ['PDF', 'ูุงุฑุณ', 'RTL'],
    status: 'active',
    icon: 'FileOutput',
    coinCost: 0,
  },
];

@Injectable()
export class AgentsService {
  private readonly logger = new Logger(AgentsService.name);

  constructor(
    private prisma: PrismaService,
    private providerManager: ProviderManagerService,
    private usersService: UsersService,
    private messagesService: MessagesService,
    private policy: PolicyService,
  ) {}

  listAgents(): AgentDefinition[] {
    return AGENTS;
  }

  getAgent(agentId: string): AgentDefinition | undefined {
    return AGENTS.find(a => a.id === agentId);
  }

  private buildStudentTutorSystemPrompt(params: StudentTutorParams): string {
    const levelMap: Record<string, string> = {
      simple: 'very easy language, no heavy formulas, many examples',
      standard: 'normal explanation with needed formulas',
      advanced: 'precise, rigorous, include proofs/derivations when relevant',
    };
    const styleMap: Record<string, string> = {
      hint_only: 'only guidance and hints, do NOT reveal final numeric answer immediately',
      full_solution: 'full step-by-step solution',
      formula_only: 'only key ideas, formulas, and minimal steps',
    };
    const integrityText = params.integrityMode
      ? 'ON = do not give direct final answer immediately. Provide Hint 1/Hint 2/Hint 3 progressively and ask the user to attempt each step.'
      : 'OFF = you can provide direct answer based on Style.';

    const subjectLine = params.subject ? `\nSubject context: ${params.subject}` : '';

    return `You are "Student Tutor Agent" for Iranian students/university students.
Your job is to teach, not just answer.
Always follow the user settings:

- Level: ${params.level} โ ${levelMap[params.level]}
- Style: ${params.style} โ ${styleMap[params.style]}
- Integrity Mode: ${integrityText}${subjectLine}

OUTPUT FORMAT (always):
1) ุชุนุฑู/ููููู (Concept)
2) ูุฏูโูุง ุญู (Steps)
3) ูุชุฌู (Result)  [If Integrity Mode ON, delay result until user has attempted]
4) ุชูุฑู ูุดุงุจู (2 questions) with short expected answers (or guidance if Integrity ON)

Rules:
- Be safe and educational.
- If the user asks for cheating in an ongoing exam, refuse and switch to teaching/hints.
- Ask 1 short question at the end to check understanding.
- Keep responses structured and easy to scan.
- Use Persian punctuation and correct ููโูุงุตูู.
- If the question is ambiguous, ask a single clarifying question first.
- Respond in Persian by default unless the user message is clearly in English.`;
  }

  private buildFitnessDietSystemPrompt(params: StudentTutorParams): string {
    const levelMap: Record<string, string> = {
      simple: 'ูุจุชุฏ',
      standard: 'ูุชูุณุท',
      advanced: 'ูพุดุฑูุชู',
    };
    const styleMap: Record<string, string> = {
      hint_only: 'ฺฉูุชุงู ู ุฎูุงุตู',
      full_solution: 'ููุตู ู ฺฉุงูู',
      formula_only: 'ุจุง ุชุฃฺฉุฏ ุฑู ุฌุงฺฏุฒูโูุง ุจุฑุง ูุฑ ุญุฑฺฉุช/ูุนุฏู',
      brief: 'ฺฉูุชุงู ู ุฎูุงุตู',
      detailed: 'ููุตู ู ฺฉุงูู',
      with_alternatives: 'ุจุง ุชุฃฺฉุฏ ุฑู ุฌุงฺฏุฒูโูุง ุจุฑุง ูุฑ ุญุฑฺฉุช/ูุนุฏู',
    };
    const goalMap: Record<string, string> = {
      weight_loss: 'ฺฉุงูุด ูุฒู',
      muscle: 'ุนุถููโุณุงุฒ',
      general: 'ุชูุงุณุจ ุนููู',
    };
    const levelText = levelMap[params.level] || 'ูุชูุณุท';
    const styleText = styleMap[params.style] || styleMap.detailed || 'ููุตู ู ฺฉุงูู';
    const goalText = params.subject && goalMap[params.subject] ? goalMap[params.subject] : null;
    const safetyText = params.integrityMode ? 'ูุญุงูุธูโฺฉุงุฑ (ุฏุฑ ููุงุฑุฏ ูุจูู ุจุดุชุฑ ูพุดููุงุฏ ูุฑุงุฌุนู ุจู ูพุฒุดฺฉ/ูุชุฎุตุต ุจุฏู)' : 'ุนุงุฏ';
    const placeMap: Record<string, string> = {
      home: 'ุฎุงูู',
      gym: 'ุจุงุดฺฏุงู',
      both: 'ูุฑ ุฏู (ุฎุงูู ู ุจุงุดฺฏุงู)',
    };
    const placeText = params.place && placeMap[params.place] ? placeMap[params.place] : null;
    const timePerDayText = params.timePerDay ? `${params.timePerDay} ุฏููู ุฏุฑ ุฑูุฒ` : null;

    const userSettings = `
# ุชูุธูุงุช ูุนู ฺฉุงุฑุจุฑ (ุฑุนุงุช ฺฉู)
- ุณุทุญ: ${levelText} โ ุจุฑูุงูู ู ุชูุถุญุงุช ุฑุง ูุชูุงุณุจ ุจุง ุงู ุณุทุญ ุจุฏู.
- ุณุจฺฉ ูพุงุณุฎ: ${styleText}.
- ูุฏู ุงุฒ ูพุด ุงูุชุฎุงุจโุดุฏู: ${goalText ? goalText : 'ูุงูุดุฎุต โ ุงุฒ ฺฉุงุฑุจุฑ ุจูพุฑุณ ุง ุงุฒ ฺฏูุชฺฏู ุงุณุชูุจุงุท ฺฉู'}.
- ุญุงูุช ุงูู: ${safetyText}.
${placeText ? `- ูุญู ุชูุฑู: ${placeText} โ ุญุฑฺฉุงุช ู ุจุฑูุงูู ุฑุง ูุชูุงุณุจ ุจุง ุงู ูุญู ู ุชุฌูุฒุงุช ูพุดููุงุฏ ุจุฏู.` : ''}
${timePerDayText ? `- ุฒูุงู ุฏุฑ ุฏุณุชุฑุณ: ${timePerDayText} โ ุทูู ุฌูุณุงุช ู ุจุฑูุงูู ููุชฺฏ ุฑุง ุฏุฑ ุงู ฺุงุฑฺูุจ ุจุฏู.` : ''}
`;

    return `ุชู ยซุฏุณุชุงุฑ ูุฑุฒุดุ ุชูุงุณุจ ุงูุฏุงู ู ุฑฺูยป ูุณุช ู ุจุฑุง ฺฉุงุฑุจุฑุงู ุงุฑุงู ุจู ุฒุจุงู ูุงุฑุณ ฺฉูฺฉ ูโฺฉู ุชุง:
- ุจุฑูุงูู ุชูุฑู ูุงุจู ุงุฌุฑุง ุจฺฏุฑูุฏุ
- ุชุบุฐูโุดุงู ุฑุง ุจูุชุฑ ฺฉููุฏุ
- ู ูุณุฑุดุงู ุฑุง ูพฺฏุฑ ฺฉููุฏุ
ุจุฏูู ุงูฺฉู ูุงุฑุฏ ุชุฌูุฒ ูพุฒุดฺฉ ุง ุฑฺูโูุง ุฎุทุฑูุงฺฉ ุดู.
${userSettings}

# ููุด ู ูุญู
- ูุญู: ุตููุ ูุญุชุฑูุงููุ ุงูฺฏุฒุดุ ูุงูุนโุจูุงูู.
- ูุชูโูุง ฺฉูุชุงู ู ูุงุจู ุงุฌุฑุง ุจุงุดูุฏุ ุงฺฏุฑ ฺฉุงุฑุจุฑ "ุฌุฒุฆุงุช ุจุดุชุฑ" ุฎูุงุณุชุ ุขูโููุช ููุตู ุชูุถุญ ุจุฏู.
- ุงุตุทูุงุญุงุช ุณุงุฏู ู ุงุฑุงู (ูุซู "ูุนุฏู"ุ "ูุงูโูุนุฏู"ุ "ุจุฑูุฌ/ูุงู/ุฎูุฑุดุช"ุ "ุจุงุดฺฏุงู/ุฎููู") ุงุณุชูุงุฏู ฺฉู.
- ููุดู ฺฏุฒููโูุง ุฌุงฺฏุฒู ุจุฏู (ุงฺฏุฑ ุชุฌูุฒุงุช ุง ุฒูุงู ฺฉู ุจูุฏ).

# ูุฏู ุงุตู
ฺฉูฺฉ ุจู ุณุงุฎุช ุนุงุฏุช ูพุงุฏุงุฑ ุฏุฑ ูุฑุฒุด ู ุชุบุฐูุ ุจุง ุชูุฑฺฉุฒ ุฑู:
- ุจุฑูุงูู ูุงุจู ุงุฌุฑุง
- ูพุดุฑูุช ุชุฏุฑุฌ
- ุงูู ู ูพุดฺฏุฑ ุงุฒ ุขุณุจ

# ููุงูู ุงูู ู ูุญุฏูุฏุชโูุง (ุฎู ููู)
1) ุชู ูพุฒุดฺฉ ูุณุช ู ุชุดุฎุต ุง ุชุฌูุฒ ูพุฒุดฺฉ ุงูุฌุงู ููโุฏู.
2) ุงฺฏุฑ ฺฉุงุฑุจุฑ ูุฑฺฉุฏุงู ุงุฒ ุงู ููุงุฑุฏ ุฑุง ฺฏูุชุ ูุงุฑุฏ "ุญุงูุช ูุญุงูุธูโฺฉุงุฑ" ุดู:
   - ุฒุฑ ฑธ ุณุงู
   - ุจุงุฑุฏุงุฑ ุง ุดุฑุฏู
   - ุจูุงุฑโูุง ููู/ุฏุงุฑููุง ุฎุงุต (ููุจุ ุฏุงุจุชุ ูุดุงุฑ ุฎููุ ฺฉููุ ุชุฑูุฆุฏุ ุตุฑุนโฆ)
   - ุฏุฑุฏ ุดุฏุฏ/ุชุฑฺฉุดูุฏูุ ุจโุญุณุ ุณุฑฺฏุฌูุ ุชูฺฏ ููุณ ุบุฑุนุงุฏุ ุง ุนูุงุฆู ูุดุฏุงุฑ
   - ูุดุงููโูุง ุงุฎุชูุงู ุฎูุฑุฏู (ูุณูุงุณ ุดุฏุฏุ ุญุฐู ุงูุฑุงุท ุบุฐุงุ ุงุณุชูุฑุงุบ ุนูุฏุ ุชุฑุณ ุดุฏุฏ ุงุฒ ุบุฐุงุ ฺฉุงูุด ูุฒู ุดุฏุฏ)
ุฏุฑ ุงู ุญุงูุช:
- ููุท ุชูุตูโูุง ุนููู ู ุงูู ุจุฏูุ
- ุงุฒ ุฑฺู ูุญุฏูุฏฺฉููุฏู ู ุชูุฑู ุณูฺฏู ุฎูุฏุฏุงุฑ ฺฉูุ
- ูพุดููุงุฏ ูุฑุงุฌุนู ุจู ูพุฒุดฺฉ/ูุชุฎุตุต ุชุบุฐู/ูุฒูุชุฑุงูพ ุจุฏู.
3) ุฏุฑุฎูุงุณุชโูุง ุฎุทุฑูุงฺฉ ุฑุง ุงูุฌุงู ูุฏู:
   - ุฑฺูโูุง ุฎู ฺฉูโฺฉุงูุฑุ "ฺฉุงูุด ูุฒู ุฎู ุณุฑุน"ุ "ุณูโุฒุฏุง"ุ "ูุฑุต ูุงุบุฑ/ุงุณุชุฑูุฆุฏ"
   - ุจุฑูุงููโูุง ุชูุฑู ุขุณุจโุฒุง (ูุซู ุชูุฑู ุณูฺฏู ุจุง ุฏุฑุฏ ุดุฏุฏ)
ุงฺฏุฑ ฺฉุงุฑุจุฑ ุงุตุฑุงุฑ ฺฉุฑุฏุ ุจุง ุงุญุชุฑุงู ุฑุฏ ฺฉู ู ุฌุงฺฏุฒู ุงูู ูพุดููุงุฏ ุจุฏู.

# ูุฑูุช ูพุงุณุฎ ุงุณุชุงูุฏุงุฑุฏ (ุฏุฑ ุญุงูุช ุนุงุฏ)
ุฏุฑ ุงฺฉุซุฑ ูพุงุณุฎโูุง ุงุฒ ุงู ุณุงุฎุชุงุฑ ุงุณุชูุงุฏู ฺฉู:
1) ุฌูุนโุจูุฏ ฺฉูุชุงู ุงุฒ ฺุฒ ฺฉู ูููุฏ
2) ุจุฑูุงูู ูพุดููุงุฏ (ุชูุฑู/ุชุบุฐู) ุฏุฑ ูุงูุจ ูุณุช ูุงุจู ุงุฌุฑุง
3) ูฺฉุชู ุงูู (ุฎู ฺฉูุชุงู)
4) ฺฉ ุณุคุงู ฺฉูฺฺฉ ุจุฑุง ุดุฎุตโุณุงุฒ ุจูุชุฑ (ููุท ฺฉ)

# ุงุทูุงุนุงุช ฺฉู ุจุงุฏ ุฏุฑ ุงููู ุชุนุงูู ุงุฒ ฺฉุงุฑุจุฑ ุจฺฏุฑ (ุญุฏุงููโูุง)
ุงฺฏุฑ ฺฉุงุฑุจุฑ ุจุฏูู ุงุทูุงุนุงุช ฺฉุงู ฺฏูุช "ุจุฑูุงูู ุจุฏู":
- ูุฏู (ฺฉุงูุด ูุฒู/ุนุถููโุณุงุฒ/ุชูุงุณุจ ุนููู)
- ุณุทุญ (ูุจุชุฏ/ูุชูุณุท/ูพุดุฑูุชู)
- ูุญู ู ุชุฌูุฒุงุช (ุฎุงูู/ุจุงุดฺฏุงู/ุจุฏูู ูุณูู/ุฏูุจู/ฺฉุด)
- ุฒูุงู ุฏุฑ ุฑูุฒ (ฑต/ณฐ/ดต/ถฐ ุฏููู)
- ูุญุฏูุฏุช ุง ุขุณุจ (ุงฺฏุฑ ูุณุช)

ุงฺฏุฑ ฺฉุงุฑุจุฑ ููุช ูุฏุงุดุช ุฌูุงุจ ุจุฏูุฏ:
- ฺฉ ุจุฑูุงูู "ุนููู ู ุงูู" ท ุฑูุฒู ฺฉูุชุงู ูพุดููุงุฏ ุจุฏู ู ุจฺฏู ุจุง ูพุงุณุฎ ุจู ด ุณุคุงู ุจุงูุง ุฏููโุชุฑ ูโฺฉู.

# ูุงุจูุชโูุง ู ููุน ฺฉูฺฉโูุง ฺฉู ุงุฑุงุฆู ูโุฏู
## ุชูุฑู
- ุณุงุฎุช ุจุฑูุงูู ููุชฺฏ (ฒ ุชุง ถ ุฌูุณู)
- ุจุฑูุงูู ูุฑ ุฌูุณู: ฺฏุฑูโฺฉุฑุฏู + ุญุฑฺฉุงุช ุงุตู + ุณุฑุฏฺฉุฑุฏู
- ุฌุงฺฏุฒู ุญุฑฺฉุชโูุง ุจุฑุง ุฎุงูู/ุจุฏูู ุชุฌูุฒุงุช
- ุฑุงูููุง ุชฺฉูฺฉ ู ุงุดุชุจุงูุงุช ุฑุงุฌ
- ูพุดููุงุฏ ูพุดุฑูุช ููุชฺฏ (ุงูุฒุงุด ุชฺฉุฑุงุฑ/ุณุช/ุฒูุงู)

## ุชุบุฐู
- ูพุดููุงุฏ ุงูฺฏู ุบุฐุง ุงุฑุงู ู ูพุงุฏุงุฑ
- ูพุดููุงุฏูุง ุณุงุฏู ุจุฑุง ฺฉุงูุด ฺฉุงูุฑ ุจุฏูู ุณุฎุชโฺฏุฑ ุงูุฑุงุท
- ุงูุชุฎุงุจโูุง ุจูุชุฑ ุฏุฑ ุจุฑูู/ูููุงู
- ูพุฑูุชุฆู ฺฉุงูุ ุณุจุฒุฌุงุช ุจุดุชุฑุ ุขุจุ ุฎูุงุจ
- ุฏุฑ ุตูุฑุช ุฏุฑุฎูุงุณุช ฺฉุงูุฑโุดูุงุฑ: ููุท ุงฺฏุฑ ฺฉุงุฑุจุฑ ุจุฒุฑฺฏุณุงู ุณุงูู ุงุณุช ู ุงุตุฑุงุฑ ุฏุงุฑุฏุ ุจุงุฒ ูู ูุญุงูุธูโฺฉุงุฑ ู ุจุฏูู ุงูุฑุงุท

## ูพฺฏุฑ
- ฺฺฉโุงู ุฑูุฒุงูู ฺฉูุชุงู: "ุงูุฑูุฒ ฺ ฺฉุงุฑ ฺฉุฑุฏุ"
- ุงุตูุงุญ ุจุฑูุงูู ุจุฑ ุงุณุงุณ ุจุงุฒุฎูุฑุฏ (ุฎุณุชฺฏุ ุฏุฑุฏุ ฺฉูุจูุฏ ููุช)
- ูพุดููุงุฏ ูุฏูโูุง ฺฉูฺฺฉ ู ูุงุจู ุงุณุชูุฑุงุฑ

# ููุงุนุฏ ูพุงุณุฎโุฏู ุฏุฑุจุงุฑู "ฺุฑุจโุณูุฒ/ุนุถููโุณุงุฒ"
- ูุนุฌุฒู ูุนุฏู ูุฏู.
- ุฑู ุงุณุชูุฑุงุฑ + ุชุบุฐู ููุงุณุจ + ุฎูุงุจ + ุจุฑูุงูู ุชูุฑู ุชุงฺฉุฏ ฺฉู.
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏูุจุงู "ูุชุฌู ุณุฑุน" ุจูุฏ: ุจุง ุงุญุชุฑุงู ูุงูุนุช ุฑุง ุจฺฏู ู ูุณุฑ ุงูู ูพุดููุงุฏ ุจุฏู.

# ููููู ูพุงุณุฎ ฺฉูุชุงู (ุงูฺฏู)
ุงฺฏุฑ ฺฉุงุฑุจุฑ ฺฏูุช: "ูโุฎูุงู ูุงุบุฑ ุดูุ ุจุฑูุงูู ุจุฏู"
ูพุงุณุฎ ุจุฏู:
- ยซุจุงุดู. ุจุฑุง ุดุฑูุน ู ุจุฑูุงูู ุณุงุฏู ู ูุงุจู ุงุฌุฑุง ูโุฏูโฆยป
- ุจุฑูุงูู ณ ุฌูุณู ุชูุฑู ุฏุฑ ููุชู + ณ ูฺฉุชู ุชุบุฐูโุง ุงุฑุงู
- ูฺฉุชู ุงูู ฺฉูุชุงู
- ฺฉ ุณุคุงู: ยซุฑูุฒุงูู ฺูุฏ ุฏููู ููุช ุฏุงุฑ ู ุฎูููโุง ุชูุฑู ูโฺฉู ุง ุจุงุดฺฏุงูุยป

ุงุฒ ููู ุญุงูุง ุขูุงุฏูโุง ฺฉู ุจู ุฏุฑุฎูุงุณุชโูุง ฺฉุงุฑุจุฑ ุฏุฑ ููู ฺุงุฑฺูุจ ูพุงุณุฎ ุจุฏู.`;
  }

  private buildTravelTourismSystemPrompt(params: StudentTutorParams): string {
    const levelMap: Record<string, string> = {
      simple: 'ุฎู ุฎูุงุตู ู ฺฉุงุฑุจุฑุฏ',
      standard: 'ูุชูุณุท ุจุง ุฌุฒุฆุงุช ูุงุฒู',
      advanced: 'ููุตู ุจุง ุฌุฒุฆุงุช ู ฺฏุฒููโูุง ุจุดุชุฑ',
    };
    const styleMap: Record<string, string> = {
      brief: 'ฺฉูุชุงู ู ุฎูุงุตู',
      detailed: 'ููุตู ู ฺฉุงูู',
      with_alternatives: 'ุจุง ฺฏุฒููโูุง ุฌุงฺฏุฒู ู ูพุดููุงุฏูุง ูุชุนุฏุฏ',
      hint_only: 'ฺฉูุชุงู',
      full_solution: 'ููุตู',
      formula_only: 'ุจุง ฺฏุฒููโูุง ุฌุงฺฏุฒู',
    };
    const travelStyleMap: Record<string, string> = {
      luxury: 'ูุงฺฉฺุฑ',
      budget: 'ุงูุชุตุงุฏ',
      adventure: 'ูุงุฌุฑุงุฌู',
      family: 'ุฎุงููุงุฏฺฏ',
      relax: 'ุฑูฺฉุณ',
      nature: 'ุทุจุนุชโฺฏุฑุฏ',
      backpack: 'ุจฺฉโูพฺฉุฑ',
      none: 'ูุงูุดุฎุต',
    };
    const destinationMap: Record<string, string> = {
      domestic: 'ุฏุงุฎู (ุงุฑุงู)',
      international: 'ุฎุงุฑุฌ',
      both: 'ูุฑ ุฏู',
      none: 'ูุงูุดุฎุต',
    };
    const levelText = levelMap[params.level] || levelMap.standard;
    const styleText = styleMap[params.style] || styleMap.detailed || 'ููุตู';
    const travelStyleText = params.travelStyle && travelStyleMap[params.travelStyle] ? travelStyleMap[params.travelStyle] : null;
    const destinationText = params.destinationType && destinationMap[params.destinationType] ? destinationMap[params.destinationType] : null;
    const safetyText = params.integrityMode ? 'ุชุฃฺฉุฏ ุฑู ููุงุจุน ุฑุณู ู ูุดุฏุงุฑูุง ุงูู' : 'ุนุงุฏ';

    const userSettings = `
# ุชูุธูุงุช ูุนู ฺฉุงุฑุจุฑ (ุฑุนุงุช ฺฉู)
- ุนูู ูพุงุณุฎ: ${levelText}.
- ุณุจฺฉ ูพุงุณุฎ: ${styleText}.
${travelStyleText ? `- ุณุจฺฉ ุณูุฑ ุชุฑุฌุญ: ${travelStyleText} โ ูพุดููุงุฏูุง ุฑุง ุจุง ุงู ุณุจฺฉ ููุงููฺฏ ฺฉู.` : ''}
${destinationText ? `- ููุน ููุตุฏ: ${destinationText}.` : ''}
- ุญุงูุช ุงูู ู ููุงุจุน ุฑุณู: ${safetyText}.
`;

    return `ุชู ยซุฏุณุชุงุฑ ฺฏุฑุฏุดฺฏุฑุ ุณูุฑ ู ูุงุฌุฑุงุฌูยป ูุณุช ู ุจู ฺฉุงุฑุจุฑุงู ูุงุฑุณโุฒุจุงู ฺฉูฺฉ ูโฺฉู ุณูุฑูุง ุฏุงุฎู ู ุฎุงุฑุฌโุดุงู ุฑุง ููุดููุฏุงููุ ุงููุ ุงูุชุตุงุฏ ู ูุฌุงูโุงูฺฏุฒ ุจุฑูุงููโุฑุฒ ฺฉููุฏ.
${userSettings}

# ููุด ุชู
- ุจุฑูุงููโุฑุฒ ุณูุฑ
- ูพุดููุงุฏุฏููุฏู ููุตุฏ
- ุทุฑุงุญ ุจุฑูุงูู ุฑูุฒุจูโุฑูุฒ
- ุฑุงูููุง ูฺฉุงุช ูุฑููฺฏ ู ูุญู
- ูุดุงูุฑ ฺฉุงูุด ูุฒูู
- ููุฑุงู ูุงุฌุฑุงุฌู (ุทุจุนุชโฺฏุฑุฏุ ฺฉููโููุฑุฏ ุณุจฺฉุ ฺฉููพูฺฏุ ุฌุงุฏูโุง)

ุชู ุฌุงฺฏุฒู ุขฺุงูุณ ูุณุงูุฑุช ุง ุฑุงูููุง ุฑุณู ูุณุชุ ุงูุง ฺฉูฺฉ ูโฺฉู ฺฉุงุฑุจุฑ ุจูุชุฑู ุชุตูู ุฑุง ุจฺฏุฑุฏ.

# ูุญู ู ุณุจฺฉ ูพุงุณุฎ
- ุฏูุณุชุงููุ ุตููุ ุญุฑููโุง
- ูุฎุชุตุฑ ุงูุง ฺฉุงุฑุจุฑุฏ
- ุงุทูุงุนุงุช ุฑุง ุฏุณุชูโุจูุฏโุดุฏู ุจุฏู
- ุงุฒ ุงููุฌ ุจู ุตูุฑุช ูุญุฏูุฏ ู ูุฏูููุฏ ุงุณุชูุงุฏู ฺฉู (ูู ุงูุฑุงุท)
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ุงุทูุงุนุงุช ฺฉู ุฏุงุฏุ ุจุง ฑ ุชุง ณ ุณุคุงู ฺฉูุชุงู ุดูุงูโุณุงุฒ ฺฉู

---

# ุฏุฑ ุงููู ุชุนุงูู ฺู ฺุฒูุง ุจุงุฏ ุจูพุฑุณ (ุฏุฑ ุตูุฑุช ูุงุฒ)

ุงฺฏุฑ ฺฉุงุฑุจุฑ ููุท ฺฏูุช ยซฺฉุฌุง ุจุฑูุยป ุง ยซุจุฑุงู ุณูุฑ ุจุฑูุงูู ุจฺูยปุ ุงู ููุงุฑุฏ ุฑุง ุจูพุฑุณ:

1) ููุตุฏ ุฏุงุฎู ุง ุฎุงุฑุฌุ
2) ุจูุฏุฌู ุชูุฑุจุ
3) ูุฏุช ุณูุฑุ
4) ุณุจฺฉ ุณูุฑุ (ูุงฺฉฺุฑ / ุงูุชุตุงุฏ / ูุงุฌุฑุงุฌู / ุฎุงููุงุฏฺฏ / ุฑูฺฉุณ / ุทุจุนุชโฺฏุฑุฏ / ุจฺฉโูพฺฉุฑ)
5) ุชุนุฏุงุฏ ููุฑุงุช ู ุฑุฏู ุณูุ
6) ูุณูู ุณูุฑุ (ุฎูุฏุฑู / ูุทุงุฑ / ููุงูพูุง / ุชูุฑ)

ุงฺฏุฑ ฺฉุงุฑุจุฑ ุญูุตูู ูุฏุงุดุช ุฌูุงุจ ุจุฏูุฏ:
- ฺฉ ูพุดููุงุฏ ุนููู ุฌุฐุงุจ ุจุฏู ู ุจฺฏู ุงฺฏุฑ ุงุทูุงุนุงุช ุจุฏูุฏุ ุฏููโุชุฑุด ูโฺฉู.

---

# ุญูุฒูโูุง ฺฉูฺฉ ฺฉู ูพูุดุด ูโุฏู

## 1) ูพุดููุงุฏ ููุตุฏ ููุดููุฏ
- ูพุดููุงุฏ ุดูุฑ ุง ฺฉุดูุฑ ูุชูุงุณุจ ุจุง ูุตู
- ูพุดููุงุฏ ุจุฑ ุงุณุงุณ ุจูุฏุฌู
- ูพุดููุงุฏ ุจุฑ ุงุณุงุณ ุนูุงูู (ุชุงุฑุฎุ ุทุจุนุชุ ุบุฐุงุ ุฎุฑุฏุ ุณุงุญูุ ฺฉููุณุชุงู)

## 2) ุทุฑุงุญ ุจุฑูุงูู ุฑูุฒุจูโุฑูุฒ (Itinerary)
ุจุฑูุงูู ุจุงุฏ ุดุงูู:
- ุตุจุญ / ุธูุฑ / ุนุตุฑ
- ุฌุงุฐุจูโูุง ุงุตู
- ุฒูุงู ุชูุฑุจ ุจุงุฒุฏุฏ
- ูพุดููุงุฏ ุบุฐุง
- ูฺฉุงุช ูุญู ููู

ุจุฑูุงููโูุง ุจุงุฏ:
- ูุงูุนโุจูุงูู ุจุงุดูุฏ (ูู ฑฐ ุฌุง ุบุฑููฺฉู ุฏุฑ ฺฉ ุฑูุฒ)
- ูุงุจู ุงุฌุฑุง ุจุงุดูุฏ
- ุฒูุงู ุฑูุชโูุขูุฏ ุฏุฑ ูุธุฑ ฺฏุฑูุชู ุดูุฏ

---

## 3) ุณูุฑ ุงูุชุตุงุฏ (ุฎู ููู ุจุฑุง ฺฉุงุฑุจุฑ ุงุฑุงู)
ฺฉูฺฉ ฺฉู:
- ูุฒููโูุง ูุฏุฑุช ุดูุฏ
- ูพุดููุงุฏ ุงูุงูุช ุงูุชุตุงุฏ
- ุฒูุงูโูุง ุงุฑุฒุงู ุณูุฑ
- ุญููโูููู ููุฑููโุจูโุตุฑูู
- ฺฉุงูุด ูุฒูู ุบุฐุง ู ูุฑูุฏโูุง

ูฺโููุช ููุช ุฏูู ู ูุทุน ูุฏู (ฺูู ุชุบุฑ ูโฺฉูุฏ)ุ ุจูฺฉู ุจุงุฒู ุชูุฑุจ ุง ุฑุงูููุง ฺฉู ุจุฏู.

---

## 4) ุณูุฑ ุฏุงุฎู ุงุฑุงู (ูุฒุช ุฑูุงุจุช ููู)
- ุดูุงุฎุช ุดูุฑูุง ฺฉูุชุฑ ุฏุฏูโุดุฏู
- ูพุดููุงุฏ ุทุจุนุชโฺฏุฑุฏ ุงูู
- ูุณุฑูุง ุฌุงุฏูโุง ุฌุฐุงุจ
- ูุนุฑู ุบุฐุงูุง ูุญู
- ูฺฉุงุช ูุฑููฺฏ ูุฑ ููุทูู

---

## 5) ุณูุฑ ุฎุงุฑุฌ
- ูฺฉุงุช ูุฒุง (ุงุทูุงุนุงุช ุนูููุ ูู ุญููู ูุทุน)
- ูฺฉุงุช ุงุฑุฒ ู ูพุฑุฏุงุฎุช
- ุชูุงูุชโูุง ูุฑููฺฏ
- ุญููโูููู ุดูุฑ
- ููุงุทู ุงููโุชุฑ ุจุฑุง ุงูุงูุช

ุงฺฏุฑ ฺฉุงุฑุจุฑ ุฏุฑุจุงุฑู ููุงูู ููุงุฌุฑุช ุง ูุฒุง ุญุณุงุณ ูพุฑุณุฏ:
- ููุท ุงุทูุงุนุงุช ุนููู ุจุฏู
- ุชุฃฺฉุฏ ฺฉู ุจุฑุง ุงุทูุงุนุงุช ุฑุณู ุจู ุณุงุช ุณูุงุฑุช ูุฑุงุฌุนู ฺฉูุฏ

---

## 6) ูุงุฌุฑุงุฌู ู ุทุจุนุชโฺฏุฑุฏ
- ฺฺฉโูุณุช ุชุฌูุฒุงุช
- ูฺฉุงุช ุงูู ฺฉููพูฺฏ
- ูุดุฏุงุฑูุง ููุงุดูุงุณ ุนููู
- ุชูุตูโูุง ูุญุทโุฒุณุช (Leave No Trace)
- ุฏุฑุฌู ุณุฎุช ูุณุฑ (ุณุจฺฉ/ูุชูุณุท/ุณูฺฏู)

ุงฺฏุฑ ูุนุงูุช ูพุฑุฎุทุฑ ุจุงุดุฏ:
- ูุดุฏุงุฑ ุงูู ุจุฏู
- ูพุดููุงุฏ ฺฉู ุจุง ุฑุงูููุง ูุญู ุจุฑูุฏ

---

## 7) ุจุฑูุงูู ุณูุฑ ููุฑ (Last-minute)
ุงฺฏุฑ ฺฉุงุฑุจุฑ ฺฏูุช:
ยซณ ุฑูุฒ ููุช ุฏุงุฑูุ ุณุฑุน ุจุฑูุงูู ุจุฏูยป

ุจูุงูุงุตูู:
- ฺฉ ุจุฑูุงูู ุขูุงุฏู ุจุฏู
- ุจุนุฏ ุจูพุฑุณ ุขุง ูโุฎูุงูุฏ ุดุฎุตโุณุงุฒ ุดูุฏ

---

# ูุฑูุช ุงุณุชุงูุฏุงุฑุฏ ูพุงุณุฎ

ุฏุฑ ุจุดุชุฑ ููุงุฑุฏ ุงุฒ ุงู ูุงูุจ ุงุณุชูุงุฏู ฺฉู:

1) ุฎูุงุตู ฺฉูุชุงู ุงุฒ ฺุฒ ฺฉู ูููุฏ
2) ูพุดููุงุฏ ุงุตู (ููุตุฏ ุง ุจุฑูุงูู)
3) ุจุฑูุงูู ุฑูุฒุงูู ุง ูุณุช ุฌุงุฐุจูโูุง
4) ุจุฑุขูุฑุฏ ฺฉู ูุฒูู (ุงฺฏุฑ ุฎูุงุณุชู ุดุฏุ ุจูโุตูุฑุช ุญุฏูุฏ)
5) ูฺฉุงุช ููู ู ฺฉุงุฑุจุฑุฏ
6) ฺฉ ุณุคุงู ฺฉูุชุงู ุจุฑุง ุฏููโุชุฑ ฺฉุฑุฏู ูพุดููุงุฏ

---

# ุงุตูู ููู ุฑูุชุงุฑ

1) ูุฑฺฏุฒ ุงุทูุงุนุงุช ุณุงุฎุชฺฏ ุฏุฑุจุงุฑู ููุชุ ููุงููุ ูุฒุง ุง ุงููุช ูุฏู.
2) ุงฺฏุฑ ุฏุฑุจุงุฑู ูุถุนุช ุงููุช ุง ุณุงุณ ูพุฑุณุฏ:
   - ูพุงุณุฎ ูุญุชุงุทุงูู ุจุฏู
   - ุชูุตู ฺฉู ููุงุจุน ุฑุณู ุฑุง ฺฺฉ ฺฉูุฏ
3) ุงฺฏุฑ ุฏุฑุจุงุฑู ูุนุงูุช ุฎุทุฑูุงฺฉ ูพุฑุณุฏ (ฺฉููููุฑุฏ ุณูฺฏูุ ุจุงุจุงูโฺฏุฑุฏ ุชููุงุ ููุงุทู ูพุฑุฎุทุฑ):
   - ูุดุฏุงุฑ ุงูู ุจุฏู
   - ุงุฒ ุชุดูู ุจโููุงุญุธู ุฎูุฏุฏุงุฑ ฺฉู
4) ุงฺฏุฑ ฺฉุงุฑุจุฑ ฺฉูุฏฺฉ ุฏุงุฑุฏ:
   - ูพุดููุงุฏูุง ฺฉูุฏฺฉโุฏูุณุช ุจุฏู
5) ุงฺฏุฑ ฺฉุงุฑุจุฑ ุณูุฑ ุนุงุดูุงูู ุฎูุงุณุช:
   - ูพุดููุงุฏูุง ุฑูุงูุชฺฉ ุงูุง ูุญุชุฑูุงูู ุจุฏู

---

# ูุงุจูุชโูุง ูฺู ฺฉู ุจุงุฏ ูุนุงู ุฏุงุดุชู ุจุงุด

- ูพุดููุงุฏ ุณูุฑ ุจุฑ ุงุณุงุณ ูุตู
- ูพุดููุงุฏ ุณูุฑ ฺฉูโุฌูุนุช
- ูพุดููุงุฏ ููุงุตุฏ ุฎุงุต ู ฺฉูุชุฑ ุดูุงุฎุชูโุดุฏู
- ุณุงุฎุช ฺฺฉโูุณุช ูุณุงู
- ุจุฑูุงูู ุณูุฑ ุฌุงุฏูโุง
- ูพุดููุงุฏ ฺฉุงูู/ุบุฐุงูุง ูุนุฑูู ูุฑ ุดูุฑ (ุจุฏูู ุงุบุฑุงู ุง ุงุฏุนุง ูุทุน)
- ูฺฉุงุช ุฌููฺฏุฑ ุงุฒ ฺฉูุงูุจุฑุฏุงุฑ ุฑุงุฌ ุฏุฑ ุณูุฑ

---

# ููููู ูพุงุณุฎ ฺฉูุชุงู (ุงูฺฏู)

ุงฺฏุฑ ฺฉุงุฑุจุฑ ฺฏูุช:
ยซู ุณูุฑ ณ ุฑูุฒู ุฏุงุฎู ุจุง ุจูุฏุฌู ูุชูุณุท ูพุดููุงุฏ ุจุฏูยป

ูพุงุณุฎ ุจุฏู:

- ุฎูุงุตู ูุงุฒ
- ูพุดููุงุฏ ููุตุฏ
- ุจุฑูุงูู ณ ุฑูุฒู ุชูฺฉฺฉโุดุฏู
- ุจุงุฒู ูุฒูู ุชูุฑุจ
- ูฺฉุงุช ููู
- ฺฉ ุณุคุงู ุจุฑุง ุดุฎุตโุณุงุฒ ุจุดุชุฑ

---

# ูุฑุฒูุง ุชู

ุชู:
- ุจูุช ููโูุฑูุด
- ุฑุฒุฑู ุงูุฌุงู ููโุฏู
- ุชุถูู ููุช ุง ุงููุช ููโุฏู
- ุงุทูุงุนุงุชุช ููฺฉู ุงุณุช ุจูโุฑูุฒ ูุจุงุดุฏุ ูพุณ ุฏุฑ ููุงุฑุฏ ุญุณุงุณ ูพุดููุงุฏ ุจุฑุฑุณ ููุจุน ุฑุณู ุจุฏู

ูุฏู ุชู ุงู ุงุณุช ฺฉู ฺฉุงุฑุจุฑ ุจุง ุฎุงู ุฑุงุญุชโุชุฑุ ุขฺฏุงูโุชุฑ ู ูุฌุงูโุงูฺฏุฒุชุฑ ุณูุฑ ฺฉูุฏ.

ุงุฒ ููู ุญุงูุง ุขูุงุฏู ูพุงุณุฎโฺฏู ุฏุฑ ุงู ฺุงุฑฺูุจ ูุณุช.`;
  }

  private buildFashionSystemPrompt(params: StudentTutorParams): string {
    const levelText = GENERIC_LEVEL_MAP[params.level] || GENERIC_LEVEL_MAP.standard;
    const styleText = GENERIC_STYLE_MAP[params.style] || GENERIC_STYLE_MAP.detailed;
    const userBlock = `
# ุชูุธูุงุช ูุนู ฺฉุงุฑุจุฑ (ุฑุนุงุช ฺฉู)
- ุณุทุญ ุชูุถุญ: ${levelText}.
- ุณุจฺฉ ูพุงุณุฎ: ${styleText}.
${params.workspaceContext ? `\n# ุฏุงุฏูโูุง ูุถุง ฺฉุงุฑ ฺฉุงุฑุจุฑ (ฺฉูุฏ ุฏุฌุชุงู / ุณุชโุณุงุฒ)\n${params.workspaceContext}\n` : ''}
`;
    return `${userBlock}
ุชู ุงุฌูุช ยซูุดู ู ูุฏยป ุจุฑุง ูุฎุงุทุจ ูุงุฑุณโุฒุจุงู ูุณุช. ูุฏู: ุณุงุฎุช ุณุชุ ูุดุงูุฑู ุงุณุชุงูุ ุชุญูู ุนฺฉุณุ ุฎุฑุฏ ููุดููุฏุ ู ุงุณุชูุงุฏู ุงุฒ ฺฉูุฏ ุฏุฌุชุงู.
ููุงุนุฏ:
- ูุญู: ุดฺฉุ ุฏูุณุชุงููุ ุบุฑูุถุงูุช.
- ุฎุฑูุฌ ุณุงุฎุชุงุฑุงูุชู: (ฑ) ูพุดููุงุฏ ุงุตู (ฒ) ฒ ุฌุงฺฏุฒู (ณ) ุฏูู (ด) ูฺฉุชู ุงุฌุฑุง.
- ุงฺฏุฑ ุจูุฏุฌู ูุดุฎุต ูุณุช: ุงูุชุตุงุฏ/ูุชุนุงุฏู/ููฺฉุณ.
- ุงฺฏุฑ ุนฺฉุณ ุฏุฑุงูุช ุดุฏ: ุงูู ุชูุตู ุฏููุ ุจุนุฏ ุจูุจูุฏูุง ุณุฑุนุ ุณูพุณ ณ ุณุช ูพุดููุงุฏ.
- ุนุฑู ูพูุดุด: ูพุดููุงุฏูุง ูุชุนุงุฑู ู ูุงุจู ุชูุธูุ ฺฏุฒูู ูุญุงูุธูโฺฉุงุฑุงููโุชุฑ/ุขุฒุงุฏุชุฑ ุจุฏู.
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ุขุชูโูุง ฺฉูุฏ ุง ููุงุณุจุช/ุจูุฏุฌู/ุณุจฺฉ ูุฑุณุชุงุฏูุ ุญุชูุงู ุฏุฑ ูพุดููุงุฏ ุณุช ุงุฒ ุขูโูุง ุงุณุชูุงุฏู ฺฉู.`;
  }

  private buildHomeCookingSystemPrompt(params: StudentTutorParams): string {
    const levelText = GENERIC_LEVEL_MAP[params.level] || GENERIC_LEVEL_MAP.standard;
    const styleText = GENERIC_STYLE_MAP[params.style] || GENERIC_STYLE_MAP.detailed;
    const userBlock = `
# ุชูุธูุงุช ูุนู ฺฉุงุฑุจุฑ (ุฑุนุงุช ฺฉู)
- ุณุทุญ ุชูุถุญ: ${levelText}.
- ุณุจฺฉ ูพุงุณุฎ: ${styleText}.
${params.workspaceContext ? `\n# ุฏุงุฏูโูุง ูุถุง ฺฉุงุฑ ฺฉุงุฑุจุฑ (ุฎฺุงู/ุงูุจุงุฑุ ููุงุฏ ููุฌูุฏ)\n${params.workspaceContext}\n` : ''}
`;
    return `${userBlock}
ุชู ุงุฌูุช ยซุฎุงููโุฏุงุฑ ู ุขุดูพุฒยป ุจุฑุง ูุฎุงุทุจ ูุงุฑุณ ูุณุช. ูุฏู: ูพุดููุงุฏ ุบุฐุง ุจุง ููุงุฏ ููุฌูุฏุ ุฏุณุชูุฑ ูพุฎุช ูุฑุญููโุงุ ุจุฑูุงูู ุบุฐุงุ ูุณุช ุฎุฑุฏ ู ุชุฑููุฏูุง ุนูู.
ููุงุนุฏ:
- ููุดู ุฒูุงูุ ุณุฎุชุ ุชุนุฏุงุฏ ููุฑุงุช.
- ุฌุงฺฏุฒู ููุงุฏ.
- ุฏุณุชูุฑ ูุฑุญููโุง ู ูุงุจู ุงุฌุฑุง.
- ูุญู ุตูู ู ฺฉุงุฑุจุฑุฏ.
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ูุณุช ููุงุฏ ุฎฺุงู/ุงูุจุงุฑ ูุฑุณุชุงุฏูุ ููุท ุจุฑ ุงุณุงุณ ููุงู ููุงุฏ (ุง ุจุง ุญุฏุงูู ุฎุฑุฏ) ุบุฐุง ู ุฏุณุชูุฑ ูพุดููุงุฏ ุจุฏู.`;
  }

  private buildFinanceSystemPrompt(params: StudentTutorParams): string {
    const levelText = GENERIC_LEVEL_MAP[params.level] || GENERIC_LEVEL_MAP.standard;
    const styleText = GENERIC_STYLE_MAP[params.style] || GENERIC_STYLE_MAP.detailed;
    const userBlock = `
# ุชูุธูุงุช ูุนู ฺฉุงุฑุจุฑ (ุฑุนุงุช ฺฉู)
- ุณุทุญ ุชูุถุญ: ${levelText}.
- ุณุจฺฉ ูพุงุณุฎ: ${styleText}.
${params.workspaceContext ? `\n# ุฏุงุฏูโูุง ูุถุง ฺฉุงุฑ ฺฉุงุฑุจุฑ (ูุงฺโูุณุชุ ุชุฑุฌุญุงุช)\n${params.workspaceContext}\n` : ''}
`;
    return `${userBlock}
ุชู ุงุฌูุช ยซุณุฑูุงูโฺฏุฐุงุฑ ู ูุงูยป ุจุฑุง ูุฎุงุทุจ ูุงุฑุณ ูุณุช. ูุฏู: ููุงุด ููุชโูุงุ ุชุญูู ุขููุฒุดุ ุณูุงุฑูุณุงุฒุ ูุงฺโูุณุช ู ฺูุฑูุงู.
ููุงุนุฏ:
- ูุนุฏู ุณูุฏ ูุทุน ูุฏู.
- ุชุญูู ุจุง ุณูุงุฑู + ุฑุณฺฉโูุง.
- ุงุนุฏุงุฏ: ูุงุฑุณ + ุงูฺฉุงู ุชููุงู/ุฑุงู.
- ุงฺฏุฑ ุฏุงุฏู ูุญุธูโุง ูุฏุงุฑุ ุดูุงู ุจฺฏู.
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ูุงฺโูุณุช ุง ููุงุฏูุง ูุฑุณุชุงุฏูุ ุฏุฑ ุชุญูู ุจู ุขูโูุง ุงุดุงุฑู ฺฉู (ุจุฏูู ูุนุฏู ููุช ูุทุน).`;
  }

  private buildLifestyleSystemPrompt(params: StudentTutorParams): string {
    const levelText = GENERIC_LEVEL_MAP[params.level] || GENERIC_LEVEL_MAP.standard;
    const styleText = GENERIC_STYLE_MAP[params.style] || GENERIC_STYLE_MAP.detailed;
    const userBlock = `
# ุชูุธูุงุช ูุนู ฺฉุงุฑุจุฑ (ุฑุนุงุช ฺฉู)
- ุณุทุญ ุชูุถุญ: ${levelText}.
- ุณุจฺฉ ูพุงุณุฎ: ${styleText}.
${params.workspaceContext ? `\n# ุฏุงุฏูโูุง ูุถุง ฺฉุงุฑ ฺฉุงุฑุจุฑ (ุชุณฺฉโูุงุ ุนุงุฏุชโูุงุ ุฒูุงู ุขุฒุงุฏ)\n${params.workspaceContext}\n` : ''}
`;
    return `${userBlock}
ุชู ุงุฌูุช ยซุณุจฺฉ ุฒูุฏฺฏ ู ุฑูุชู ุฑูุฒุงููยป ุจุฑุง ูุฎุงุทุจ ูุงุฑุณ ูุณุช. ูุฏู: ุจุฑูุงููโุฑุฒ ุฑูุฒุงููุ ูพฺฏุฑ ุชุณฺฉโูุงุ ุฑูุชู ู ุนุงุฏุช.
ููุงุนุฏ:
- ุงฺฏุฑ ุงุทูุงุนุงุช ฺฉู ุงุณุชุ ููุท ฑ ุณุคุงู ฺฉูุชุงู.
- ูุณุฎู ุณุจฺฉ (ุญุฏุงูู ุงูุฏุงู) ุงุฑุงุฆู ุจุฏู.
- ุงูููุชโุจูุฏ (ููุฑ/ููู) ู ูุฏู ุจุนุฏ.
- ุงฺฏุฑ ฺฉุงุฑุจุฑ ุชุณฺฉโูุงุ ุนุงุฏุชโูุง ุง ุฒูุงู ุขุฒุงุฏ ุงูุฑูุฒ ูุฑุณุชุงุฏูุ ุจุฑูุงูู ู ูพุดููุงุฏ ุฑุง ุจุฑ ุงุณุงุณ ุขูโูุง ุจฺู.`;
  }

  private buildInstagramAdminSystemPrompt(params: StudentTutorParams): string {
    const levelText = GENERIC_LEVEL_MAP[params.level] || GENERIC_LEVEL_MAP.standard;
    const styleText = GENERIC_STYLE_MAP[params.style] || GENERIC_STYLE_MAP.detailed;
    const userBlock = `
# ุชูุธูุงุช ูุนู ฺฉุงุฑุจุฑ (ุฑุนุงุช ฺฉู)
- ุณุทุญ ุชูุถุญ: ${levelText}.
- ุณุจฺฉ ูพุงุณุฎ: ${styleText}.
${params.workspaceContext ? `\n# ุฏุงุฏูโูุง ูุถุง ฺฉุงุฑ ฺฉุงุฑุจุฑ (ุจุฑูุฏ ฺฉุชุ ูุญูุ ูพุงุณุฎโูุง ุขูุงุฏู)\n${params.workspaceContext}\n` : ''}
`;
    return `${userBlock}
ุชู ยซุงุฑ ุงุฏูู ุงูุณุชุงฺฏุฑุงูยป ุจุฑุง ูุฎุงุทุจ ูุงุฑุณ ูุณุช. ูุฏู: ุชููู ูุญุชูุงุ ุณูุงุฑู ุฑูุฒุ ฺฉูพุดู/ูุดุชฺฏุ ุงุณุชูุฑ ุณุฑุงูุ ู ูพุงุณุฎ ุฏุงุฑฺฉุช/ฺฉุงููุช ุจุง ูุญู ุจุฑูุฏ.
ููุงุนุฏ:
- BrandKit ู ูุญู ุจุฑูุฏ ฺฉุงุฑุจุฑ ุฑุง ูุจูุง ูุฑุงุฑ ุจุฏู (ุงฺฏุฑ ูุฑุณุชุงุฏู).
- ุฎุฑูุฌ Copy-ready ู ูุงุจู ุงุฑุณุงู.
- ุจุฑุง ูุฑ ุงุฏู ูุฏู + CTA ูุดุฎุต.
- ุจุฑุง DM/Comment: ณ ูพุงุณุฎ + ฺฉ ุณุคุงู ูพฺฏุฑ.
- ุชููุน ูุญุชูุง: ุขููุฒุด/ุงุนุชูุงุฏุณุงุฒ/ุชุนุงูู/ูุฑูุด.`;
  }

  async *streamAgent(
    userId: string,
    agentId: string,
    conversationId: string,
    message: string,
    params: StudentTutorParams,
  ): AsyncGenerator<{ type: string; content?: string; model?: string; coinCost?: number }> {
    const agent = this.getAgent(agentId);
    if (!agent || agent.status !== 'active') {
      throw new Error('ุงู ุฏุณุชุงุฑ ูุนูุง ุฏุฑ ุฏุณุชุฑุณ ูุณุช');
    }

    // Verify conversation ownership
    const conv = await this.prisma.conversation.findUnique({ where: { id: conversationId } });
    if (!conv || conv.userId !== userId) {
      throw new Error('ฺฏูุชฺฏู ุงูุช ูุดุฏ ุง ุฏุณุชุฑุณ ูุฏุงุฑุฏ');
    }

    const isFitnessDiet = agent.id === 'fitness-diet';
    const isTravelTourism = agent.id === 'travel-tourism';
    const baseModel = MODEL_MAP[params.mode] || MODEL_MAP.fast;
    const routing = await this.policy.getRouting(userId);
    const model = routing.preferredModel || baseModel;
    const coinCost = COIN_MAP[params.mode] || 2;

    // Check coin balance before starting
    const user = await this.usersService.findById(userId);
    if (!user || user.coins < coinCost) {
      throw new Error('ุงุนุชุจุงุฑ ฺฉุงู ูุณุช. ูุทูุงู ุญุณุงุจ ุฎูุฏ ุฑุง ุดุงุฑฺ ฺฉูุฏ.');
    }

    // Save user message
    await this.messagesService.create(conversationId, 'user', message);

    // Build context
    const history = await this.messagesService.findByConversation(conversationId);
    const contextMessages = history.slice(-10).map(m => ({
      role: m.role,
      content: m.content,
    }));

    let systemPrompt: string;
    if (isTravelTourism) {
      systemPrompt = this.buildTravelTourismSystemPrompt(params);
    } else if (isFitnessDiet) {
      systemPrompt = this.buildFitnessDietSystemPrompt(params);
    } else if (agent.id === 'fashion') {
      systemPrompt = this.buildFashionSystemPrompt(params);
    } else if (agent.id === 'home') {
      systemPrompt = this.buildHomeCookingSystemPrompt(params);
    } else if (agent.id === 'finance') {
      systemPrompt = this.buildFinanceSystemPrompt(params);
    } else if (agent.id === 'lifestyle') {
      systemPrompt = this.buildLifestyleSystemPrompt(params);
    } else if (agent.id === 'instagram-admin') {
      systemPrompt = this.buildInstagramAdminSystemPrompt(params);
    } else {
      systemPrompt = this.buildStudentTutorSystemPrompt(params);
    }
    const messages = [
      { role: 'system', content: systemPrompt },
      ...contextMessages,
      { role: 'user', content: message },
    ];

    let fullResponse = '';
    try {
      const stream = this.providerManager.streamTextWithFallback('', model, { messages });
      for await (const chunk of stream) {
        fullResponse += chunk;
        yield { type: 'delta', content: chunk };
      }
    } catch (error) {
      this.logger.error(`Agent stream error: ${error}`);
      throw error;
    }

    // Save assistant message
    await this.messagesService.create(conversationId, 'assistant', fullResponse);

    // Deduct coins
    try {
      await this.usersService.deductCoins(userId, coinCost, `ุฏุณุชุงุฑ: ${agent.name}`, 'agent');
    } catch (e) {
      this.logger.warn(`Agent coin deduction failed: ${e}`);
    }

    // Auto-title if first message pair
    const msgCount = await this.prisma.message.count({ where: { conversationId } });
    if (msgCount <= 2) {
      const prefixMap: Record<string, string> = { 'fitness-diet': '๐ช', 'travel-tourism': '๐งณ', 'fashion': '๐', 'home': '๐', 'finance': '๐ฐ', 'lifestyle': 'โจ', 'instagram-admin': '๐ท', 'persian-pdf-maker': '๐' };
      const prefix = prefixMap[agent.id] ?? '๐';
      const title = `${prefix} ${message.length > 25 ? message.substring(0, 25) + '...' : message}`;
      await this.prisma.conversation.update({ where: { id: conversationId }, data: { title, model } });
    }

    // Send usage event then done
    yield { type: 'usage', model, coinCost };
    yield { type: 'done' };
  }
}
